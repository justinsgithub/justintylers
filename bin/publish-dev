#!/usr/bin/env ruby

# frozen_string_literal: true

require 'mongoid'

require 'fileutils'

Mongoid.configure do |config|
  config.clients.default = {
    uri: ENV["DEV_MONGO_URI"]
  }
  config.log_level = :warn
end

class Writing
  include Mongoid::Document
  include Mongoid::Timestamps
  field :slug, type: String
end

def insert_id(path, id)
  tempfile = File.open('file.tmp', 'w')
  f = File.new(path)
  f.each do |line|
    tempfile << line
    tempfile << "id: #{id}\n" if f.lineno == 1
  end
  f.close
  tempfile.close
  FileUtils.mv('file.tmp', path)
end

def update_writing(filename)
  slug = filename.strip.gsub('.md', '')
  writing = Writing.where(slug: slug).first
  return if writing

  path = "content/writings/#{filename}"
  new_writing = Writing.create!(slug: slug)
  insert_id(path, new_writing.id)
  puts new_writing
end

def publish_writings
  files = Dir.entries('content/writings').select { |x| x.include? 'md' }
  files.each do |file|
    update_writing(file)
  end
end

publish_writings

